<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DLCard</title>
<style>
body{margin:0;font-family:system-ui;background:#070A12;color:#EAF0FF}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0B1022}
button{background:#7CF7D8;border:0;border-radius:8px;padding:8px 14px;cursor:pointer}
main{padding:16px}
.card{background:#0E1633cc;border:1px solid #26325f;border-radius:12px;padding:12px;margin-bottom:12px}
a{color:#7AA7FF;text-decoration:none}
nav a{margin-right:10px}
</style>
</head>
<body>
<header>
  <div>DLCard</div>
  <div id="authBox"></div>
</header>
<nav style="padding:8px 16px">
  <a href="#/">首頁</a>
  <a href="#/profile">會員</a>
  <a href="#/wallet">錢包</a>
  <a href="#/mall/1">商城</a>
</nav>
<main id="app"></main>
<script>
const API = "https://apidlcard.dreamlight.site";
async function api(path, opt={}){
  return fetch(API+path,{credentials:"include",...opt});
}

async function getMe(){
  const r = await api('/auth/me');
  if(!r.ok) return null;
  const d = await r.json();
  if(d.logged_in===false) return null;
  return d.user ?? d;
}

async function renderAuth(){
  const box = document.getElementById('authBox');
  const me = await getMe();
  if(!me){
    box.innerHTML = `<a href="${API}/auth/google"><button>Google 登入</button></a>`;
  }else{
    box.innerHTML = `歡迎 ${me.nickname||me.email} <button id="logoutBtn">登出</button>`;
    document.getElementById('logoutBtn').onclick = async()=>{await api('/auth/logout',{method:'POST'});location.reload();};
  }
}

async function router(){
  const view = document.getElementById('app');
  const hash = location.hash || '#/';
  if(hash.startsWith('#/bind-phone')){
    view.innerHTML = `<div class='card'><h3>綁定手機</h3><input id='phone' placeholder='手機號碼'><button id='bind'>送出</button></div>`;
    document.getElementById('bind').onclick = async()=>{
      const p = document.getElementById('phone').value;
      await api('/user/bind-phone',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p})});
      location.hash='#/profile';
    };
  }
  else if(hash.startsWith('#/profile')){
    const me = await getMe();
    if(!me){ location.hash='#/'; return; }
    view.innerHTML = `<div class='card'><h3>會員資料</h3><pre>${JSON.stringify(me,null,2)}</pre><button id='qr'>產生QR</button><div id='qrBox'></div></div>`;
    document.getElementById('qr').onclick = async()=>{
      const r = await api('/user/qr-token',{method:'POST'});
      const d = await r.json();
      document.getElementById('qrBox').innerText = d.qr_token;
    };
  }
  else if(hash.startsWith('#/wallet')){
    const r = await api('/wallet/ledger');
    const d = await r.json();
    view.innerHTML = `<div class='card'><h3>點數流水</h3><pre>${JSON.stringify(d,null,2)}</pre></div>`;
  }
  else if(hash.startsWith('#/mall/')){
    const id = hash.split('/')[2];
    const r = await api(`/malls/${id}/products`);
    const d = await r.json();
    view.innerHTML = `<div class='card'><h3>商城 ${id}</h3><pre>${JSON.stringify(d,null,2)}</pre></div>`;
  }
  else{
    view.innerHTML = `<div class='card'><h3>首頁</h3><p>歡迎使用 DLCard</p></div>`;
  }
}

window.addEventListener('hashchange', router);
renderAuth();router();
</script>
</body>
</html>
